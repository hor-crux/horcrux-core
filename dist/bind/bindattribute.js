define(["require", "exports", "./bind", "../attribute/attribute", "observejs"], function (require, exports, bind_1, attribute_1, observejs_1) {
    function bindAttribute(node, attr, model) {
        //TODO use Bindings
        //TODO also detect CustomAttribute with non-{{}} Values
        bind_1.regex.lastIndex = 0;
        var match = bind_1.regex.exec(attr.value);
        if (match) {
            var path = match[1];
            if (attribute_1.Attributes[attr.name.toLowerCase()] !== undefined) {
                return bindCustomAttribute(node, attr, model, path);
            }
            else if (!!/\(.*\)/.exec(attr.value)) {
                bindFunctionWithParamAttribute(node, attr, model, path);
            }
            else if (typeof model.get(path).value === "function") {
                bindFunctionAttribute(node, attr, model, path);
            }
            else if (attr.name[0] === '#') {
                bindProperty(node, attr, model, path);
            }
            else {
                bindTextAttribute(node, attr, model, path);
            }
        }
    }
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = bindAttribute;
    function bindTextAttribute(node, attr, model, path) {
        var originalValue = attr.value;
        var _a = model.get(path), object = _a.object, value = _a.value;
        var observer = new observejs_1.PathObserver(object, path);
        var r = new RegExp("\{\{" + path + "\}\}", "g");
        var cb = function (newVal, oldVal) {
            attr.value = originalValue.replace(r, newVal);
        };
        observer.open(cb);
        cb(value, null);
    }
    function bindProperty(node, attr, model, path) {
        (function (node, attr, model, path) {
            var _a = model.get(path), object = _a.object, value = _a.value;
            var observer = new observejs_1.PathObserver(object, path);
            var cb = function (newVal, oldVal) {
                node[attr.name.substr(1)] = newVal;
            };
            observer.open(cb);
            cb(value, null);
            attr.ownerElement.removeAttribute(attr.name);
        })(node, attr, model, path);
    }
    var regex_params = /\((.+)\)/;
    var regex_function = /(.*)\(/;
    function bindFunctionWithParamAttribute(node, attr, model, path) {
        regex_params.lastIndex = 0;
        regex_function.lastIndex = 0;
        var params = regex_params.exec(path)[1]
            .split(",")
            .map(function (param) { return param.trim(); })
            .map(function (param) {
            var value = model.get(param).value;
            return typeof value === "undefined" ? param : value;
        });
        //TODO map params to types e.g. 'true' to boolean, 1.2 to number...
        var functionName = regex_function.exec(path)[1];
        var _a = model.get(functionName), object = _a.object, value = _a.value;
        attr.ownerElement.removeAttribute(attr.name);
        node[attr.name.toLocaleLowerCase()] = function (event) {
            value.apply(object, params);
        };
    }
    function bindFunctionAttribute(node, attr, model, path) {
        var _a = model.get(path), object = _a.object, value = _a.value;
        attr.ownerElement.removeAttribute(attr.name);
        node[attr.name.toLocaleLowerCase()] = function (event) {
            value.call(object, event);
        };
    }
    function bindCustomAttribute(node, attr, model, path) {
        var customAttr = new attribute_1.Attributes[attr.name](node, attr, model, path);
        var _a = model.get(path), object = _a.object, value = _a.value;
        var observer = new observejs_1.PathObserver(object, path);
        var cb = function (newVal, oldVal) {
            customAttr.newJSValue(newVal);
        };
        observer.open(cb);
        cb(value, null);
    }
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJpbmQvYmluZGF0dHJpYnV0ZS50cyJdLCJuYW1lcyI6WyJiaW5kQXR0cmlidXRlIiwiYmluZFRleHRBdHRyaWJ1dGUiLCJiaW5kUHJvcGVydHkiLCJiaW5kRnVuY3Rpb25XaXRoUGFyYW1BdHRyaWJ1dGUiLCJiaW5kRnVuY3Rpb25BdHRyaWJ1dGUiLCJiaW5kQ3VzdG9tQXR0cmlidXRlIl0sIm1hcHBpbmdzIjoiO0lBS0EsdUJBQXNDLElBQVMsRUFBRSxJQUFTLEVBQUUsS0FBVztRQUV0RUEsbUJBQW1CQTtRQUNuQkEsdURBQXVEQTtRQUV2REEsWUFBS0EsQ0FBQ0EsU0FBU0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDcEJBLElBQUlBLEtBQUtBLEdBQUdBLFlBQUtBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBQ25DQSxFQUFFQSxDQUFBQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNWQSxJQUFJQSxJQUFJQSxHQUFHQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUVwQkEsRUFBRUEsQ0FBQUEsQ0FBQ0Esc0JBQVVBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLEtBQUtBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN0REEsTUFBTUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxFQUFFQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNyREEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3JDQSw4QkFBOEJBLENBQUNBLElBQUlBLEVBQUVBLElBQUlBLEVBQUVBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1lBQ3pE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LFVBQUNBLE1BQU1BLEVBQUVBLE1BQU1BO1lBQ3ZCQSxVQUFVQSxDQUFDQSxVQUFVQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUMvQkEsQ0FBQ0EsQ0FBQ0E7UUFDRkEsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDbEJBLEVBQUVBLENBQUNBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO0lBQ2pCQSxDQUFDQSIsImZpbGUiOiJiaW5kL2JpbmRhdHRyaWJ1dGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3JlZ2V4fSBmcm9tIFwiLi9iaW5kXCJcbmltcG9ydCB7QXR0cmlidXRlc30gZnJvbSBcIi4uL2F0dHJpYnV0ZS9hdHRyaWJ1dGVcIlxuaW1wb3J0IE1vZGVsIGZyb20gXCIuL21vZGVsXCJcbmltcG9ydCB7UGF0aE9ic2VydmVyfSBmcm9tIFwib2JzZXJ2ZWpzXCJcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gYmluZEF0dHJpYnV0ZShub2RlOk5vZGUsIGF0dHI6QXR0ciwgbW9kZWw6TW9kZWwpOiB2b2lkIHtcblx0XG5cdC8vVE9ETyB1c2UgQmluZGluZ3Ncblx0Ly9UT0RPIGFsc28gZGV0ZWN0IEN1c3RvbUF0dHJpYnV0ZSB3aXRoIG5vbi17e319IFZhbHVlc1xuXHRcblx0cmVnZXgubGFzdEluZGV4ID0gMDtcblx0bGV0IG1hdGNoID0gcmVnZXguZXhlYyhhdHRyLnZhbHVlKTtcblx0aWYobWF0Y2gpIHtcblx0XHRsZXQgcGF0aCA9IG1hdGNoWzFdO1xuXHRcdFxuXHRcdGlmKEF0dHJpYnV0ZXNbYXR0ci5uYW1lLnRvTG93ZXJDYXNlKCldICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdHJldHVybiBiaW5kQ3VzdG9tQXR0cmlidXRlKG5vZGUsIGF0dHIsIG1vZGVsLCBwYXRoKTtcblx0XHR9XG5cdFx0ZWxzZSBpZighIS9cXCguKlxcKS8uZXhlYyhhdHRyLnZhbHVlKSkge1xuXHRcdFx0YmluZEZ1bmN0aW9uV2l0aFBhcmFtQXR0cmlidXRlKG5vZGUsIGF0dHIsIG1vZGVsLCBwYXRoKTtcblx0XHR9XG5cdFx0ZWxzZSBpZih0eXBlb2YgbW9kZWwuZ2V0KHBhdGgpLnZhbHVlID09PSBcImZ1bmN0aW9uXCIpIHtcblx0XHRcdGJpbmRGdW5jdGlvbkF0dHJpYnV0ZShub2RlLCBhdHRyLCBtb2RlbCwgcGF0aCk7XG5cdFx0fVxuXHRcdGVsc2UgaWYoYXR0ci5uYW1lWzBdID09PSAnIycpIHtcblx0XHRcdGJpbmRQcm9wZXJ0eShub2RlLCBhdHRyLCBtb2RlbCwgcGF0aCk7XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0YmluZFRleHRBdHRyaWJ1dGUobm9kZSwgYXR0ciwgbW9kZWwsIHBhdGgpO1xuXHRcdH1cblx0fVxufVxuXG5mdW5jdGlvbiBiaW5kVGV4dEF0dHJpYnV0ZShub2RlOk5vZGUsIGF0dHI6QXR0ciwgbW9kZWw6TW9kZWwsIHBhdGg6c3RyaW5nKTogdm9pZCB7XG5cdGxldCBvcmlnaW5hbFZhbHVlID0gYXR0ci52YWx1ZTtcblx0XG5cdGxldCB7b2JqZWN0LCB2YWx1ZX0gPSBtb2RlbC5nZXQocGF0aCk7XG5cdFxuXHRsZXQgb2JzZXJ2ZXIgPSBuZXcgUGF0aE9ic2VydmVyKG9iamVjdCwgcGF0aCk7XG5cdGxldCByID0gbmV3IFJlZ0V4cChcIlxce1xce1wiICsgcGF0aCArIFwiXFx9XFx9XCIsIFwiZ1wiKVxuXHRcblx0bGV0IGNiID0gKG5ld1ZhbCwgb2xkVmFsKSA9PiB7XG5cdFx0YXR0ci52YWx1ZSA9IG9yaWdpbmFsVmFsdWUucmVwbGFjZShyLCBuZXdWYWwpO1xuXHR9O1xuXHRvYnNlcnZlci5vcGVuKGNiKTtcblx0Y2IodmFsdWUsIG51bGwpO1xufVxuXG5mdW5jdGlvbiBiaW5kUHJvcGVydHkobm9kZTpOb2RlLCBhdHRyOkF0dHIsIG1vZGVsOk1vZGVsLCBwYXRoOnN0cmluZyk6IHZvaWQge1xuXHQoZnVuY3Rpb24obm9kZSwgYXR0ciwgbW9kZWwsIHBhdGgpIHtcblx0XHRsZXQge29iamVjdCwgdmFsdWV9ID0gbW9kZWwuZ2V0KHBhdGgpO1xuXHRcdFxuXHRcdGxldCBvYnNlcnZlciA9IG5ldyBQYXRoT2JzZXJ2ZXIob2JqZWN0LCBwYXRoKTtcblx0XHRsZXQgY2IgPSAobmV3VmFsLCBvbGRWYWwpID0+IHtcblx0XHRcdG5vZGVbYXR0ci5uYW1lLnN1YnN0cigxKV0gPSBuZXdWYWw7XG5cdFx0fTtcblx0XHRvYnNlcnZlci5vcGVuKGNiKTtcblx0XHRjYih2YWx1ZSwgbnVsbCk7XG5cdFx0YXR0ci5vd25lckVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHIubmFtZSk7XG5cdH0pKG5vZGUsIGF0dHIsIG1vZGVsLCBwYXRoKVxuXHRcbn1cblxubGV0IHJlZ2V4X3BhcmFtcyA9IC9cXCgoLispXFwpLztcbmxldCByZWdleF9mdW5jdGlvbiA9IC8oLiopXFwoLztcblxuZnVuY3Rpb24gYmluZEZ1bmN0aW9uV2l0aFBhcmFtQXR0cmlidXRlKG5vZGU6Tm9kZSwgYXR0cjpBdHRyLCBtb2RlbDpNb2RlbCwgcGF0aDpzdHJpbmcpOiB2b2lkIHtcblx0cmVnZXhfcGFyYW1zLmxhc3RJbmRleCA9IDA7XG5cdHJlZ2V4X2Z1bmN0aW9uLmxhc3RJbmRleCA9IDA7XG5cdFxuXHRsZXQgcGFyYW1zID0gcmVnZXhfcGFyYW1zLmV4ZWMocGF0aClbMV1cblx0XHQuc3BsaXQoXCIsXCIpXG5cdFx0Lm1hcChwYXJhbSA9PiB7cmV0dXJuIHBhcmFtLnRyaW0oKX0pXG5cdFx0Lm1hcChwYXJhbSA9PiB7XG5cdFx0XHRsZXQgdmFsdWUgPSBtb2RlbC5nZXQocGFyYW0pLnZhbHVlO1xuXHRcdFx0cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gXCJ1bmRlZmluZWRcIiA/IHBhcmFtIDogdmFsdWU7XG5cdFx0fSk7XG5cdFx0XG5cdC8vVE9ETyBtYXAgcGFyYW1zIHRvIHR5cGVzIGUuZy4gJ3RydWUnIHRvIGJvb2xlYW4sIDEuMiB0byBudW1iZXIuLi5cblx0XHRcblx0bGV0IGZ1bmN0aW9uTmFtZSA9IHJlZ2V4X2Z1bmN0aW9uLmV4ZWMocGF0aClbMV07XG5cdFxuXHRsZXQge29iamVjdCwgdmFsdWV9ID0gbW9kZWwuZ2V0KGZ1bmN0aW9uTmFtZSk7XG5cdFxuXHRhdHRyLm93bmVyRWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoYXR0ci5uYW1lKTtcblx0bm9kZVthdHRyLm5hbWUudG9Mb2NhbGVMb3dlckNhc2UoKV0gPSBldmVudCA9PiB7XG5cdFx0dmFsdWUuYXBwbHkob2JqZWN0LCBwYXJhbXMpO1xuXHR9XG59XG5cbmZ1bmN0aW9uIGJpbmRGdW5jdGlvbkF0dHJpYnV0ZShub2RlOk5vZGUsIGF0dHI6QXR0ciwgbW9kZWw6TW9kZWwsIHBhdGg6c3RyaW5nKTogdm9pZCB7XG5cdGxldCB7b2JqZWN0LCB2YWx1ZX0gPSBtb2RlbC5nZXQocGF0aCk7XG5cdFxuXHRhdHRyLm93bmVyRWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoYXR0ci5uYW1lKTtcblx0bm9kZVthdHRyLm5hbWUudG9Mb2NhbGVMb3dlckNhc2UoKV0gPSBldmVudCA9PiB7XG5cdFx0dmFsdWUuY2FsbChvYmplY3QsIGV2ZW50KTtcblx0fVxufVxuXG5cbmZ1bmN0aW9uIGJpbmRDdXN0b21BdHRyaWJ1dGUobm9kZTpOb2RlLCBhdHRyOkF0dHIsIG1vZGVsOk1vZGVsLCBwYXRoOnN0cmluZyk6IHZvaWQge1xuXHRsZXQgY3VzdG9tQXR0ciA9IG5ldyBBdHRyaWJ1dGVzW2F0dHIubmFtZV0obm9kZSwgYXR0ciwgbW9kZWwsIHBhdGgpO1xuXHRcblx0bGV0IHtvYmplY3QsIHZhbHVlfSA9IG1vZGVsLmdldChwYXRoKTtcblx0XG5cdGxldCBvYnNlcnZlciA9IG5ldyBQYXRoT2JzZXJ2ZXIob2JqZWN0LCBwYXRoKTtcblx0bGV0IGNiID0gKG5ld1ZhbCwgb2xkVmFsKSA9PiB7XG5cdFx0Y3VzdG9tQXR0ci5uZXdKU1ZhbHVlKG5ld1ZhbCk7XG5cdH07XG5cdG9ic2VydmVyLm9wZW4oY2IpO1xuXHRjYih2YWx1ZSwgbnVsbCk7XG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
