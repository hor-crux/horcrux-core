define(["require", "exports", "./events", "../../bind/bind"], function (require, exports, events_1, bind_1) {
    /**
     * Creates a new HTMLElement.prototype, assigns all properties of 'new target()' to it and returns it;
     */
    function createPrototype(target) {
        var proto = Object.create(HTMLElement.prototype);
        function g(p, k) {
            do {
                if (p.hasOwnProperty(k))
                    return p;
                else
                    p = (p.prototype || p.__proto__);
            } while (true);
        }
        for (var key in target.prototype) {
            Object.defineProperty(proto, key, Object.getOwnPropertyDescriptor(g(target.prototype, key), key));
        }
        /*
        let t = target;
        do {
            t = t.prototype || t.__proto__;
            Object.getOwnPropertyNames(t)
            .forEach(key => {
                Object.defineProperty(proto, key, Object.getOwnPropertyDescriptor(t, key));
            })
        } while(!!(t.prototype || t.__proto__))
        
        for(let key in target.prototype)
            proto[key] = target.prototype[key];
        */
        return proto;
    }
    exports.createPrototype = createPrototype;
    /**
     * Adds a function named 'key' to 'target', which is a function that calls 'cb' with given 'args'
     * and then calls the previous 'target[key]' if it was a function with 'args'.
     */
    function assignCallback(target, key, cb, args) {
        if (args === void 0) { args = []; }
        var original = target[key];
        target[key] = function () {
            cb.apply(this, args);
            typeof original === "function" ? original.apply(this, arguments) : '';
        };
    }
    exports.assignCallback = assignCallback;
    /**
     * Default 'createdCallback' for a Customelement. Appends the 'template' content to shadowroot, if !!template
     */
    function createdCallback(template, target) {
        var _this = this;
        target.call(this);
        if (!!template) {
            var shadow = this.createShadowRoot();
            var clone = document.importNode(template.content, true);
            shadow.appendChild(clone);
            var wc = window["WebComponents"];
            if (wc && wc.ShadowCSS)
                wc.ShadowCSS.shimStyling(template.content, target.selector, "");
            if (template.hasAttribute("lazy"))
                this.lazy = true;
            if (!this.lazy && !(this.parentComponent && this.parentComponent.lazy) && !hasLazyParent(this))
                bind_1.bindDom(shadow, [this].concat(this.ancestors));
            else if (this.lazy) {
                var uncreated = [].filter.call(shadow.querySelectorAll("*"), function (element) { return element.nodeName.indexOf("-") > -1; });
                var id = this.eventBus.addEventListener(events_1.ComponentCreatedEvent, function (e) {
                    var index = uncreated.indexOf(e.data);
                    if (index > -1)
                        uncreated.splice(index, 1);
                    if (uncreated.length == 0) {
                        bind_1.bindDom(shadow, [_this].concat(_this.ancestors));
                        _this.eventBus.removeEventListener(id);
                        _this.eventBus.dispatch(new events_1.ComponentReadyEvent(_this));
                    }
                });
            }
            else if (this.parentComponent && this.parentComponent.lazy) {
                var id = this.parentComponent.eventBus.addEventListener(events_1.ComponentReadyEvent, function (e) {
                    bind_1.bindDom(shadow, [_this].concat(_this.ancestors));
                    _this.parentComponent.eventBus.removeEventListener(id);
                });
            }
            else if (!this.parentComponent && hasLazyParent(this)) {
                var id = this.eventBus.addEventListener(events_1.ComponentCanBindEvent, function (e) {
                    bind_1.bindDom(shadow, [_this].concat(_this.ancestors));
                    _this.eventBus.removeEventListener(id);
                });
            }
        }
        this.onCreated.forEach(function (method) {
            method.call(_this, _this);
        });
        this.created();
    }
    exports.createdCallback = createdCallback;
    function attachedCallback() {
        var _this = this;
        if (this.parentComponent && this.parentComponent.lazy)
            this.parentComponent.eventBus.dispatch(new events_1.ComponentCreatedEvent(this));
        this.onAttached.forEach(function (method) {
            method.call(_this, _this);
        });
        this.attached();
    }
    exports.attachedCallback = attachedCallback;
    function detachedCallback() {
        var _this = this;
        this.onDetached.forEach(function (method) {
            method.call(_this, _this);
        });
        this.detached();
    }
    exports.detachedCallback = detachedCallback;
    function hasLazyParent(node) {
        while (node = node.parentNode) {
            if (node.hasAttribute && node.hasAttribute("lazy"))
                return true;
        }
        return false;
    }
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudC9yZWdpc3Rlci9wcm90b3R5cGUudHMiXSwibmFtZXMiOlsiY3JlYXRlUHJvdG90eXBlIiwiY3JlYXRlUHJvdG90eXBlLmciLCJhc3NpZ25DYWxsYmFjayIsImNyZWF0ZWRDYWxsYmFjayIsImF0dGFjaGVkQ2FsbGJhY2siLCJkZXRhY2hlZENhbGxiYWNrIiwiaGFzTGF6eVBhcmVudCJdLCJtYXBwaW5ncyI6IjtJQVFBOztPQUVHO0lBQ0gseUJBQXlCLE1BQVU7UUFDbENBLElBQUlBLEtBQUtBLEdBQUdBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBO1FBRWpEQSxXQUFXQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUNQQyxHQUFHQSxDQUFDQTtnQkFBQUEsRUFBRUEsQ0FBQUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO2dCQUFDQSxJQUFJQTtvQkFBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsU0FBU0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQUE7WUFBQUEsQ0FBQ0EsUUFBT0EsSUFBSUEsRUFBQ0E7UUFDekZBLENBQUNBO1FBQ1JELEdBQUdBLENBQUFBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBQ2pDQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQSxLQUFLQSxFQUFFQSxHQUFHQSxFQUFFQSxNQUFNQSxDQUFDQSx3QkFBd0JBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLEVBQUVBLEdBQUdBLENBQUNBLEVBQUVBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1FBQ25HQSxDQUFDQTtRQUVEQTs7Ozs7Ozs7Ozs7O1VBWUVBO1FBQ0ZBLE1BQU1BLENBQUNBLEtBQUtB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Q0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7b0JBQ3RDQSxFQUFFQSxDQUFBQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTt3QkFBQ0EsU0FBU0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQzFDQSxFQUFFQSxDQUFBQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTt3QkFDMUJBLGNBQU9BLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEtBQUlBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLEtBQUlBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO3dCQUMvQ0EsS0FBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTt3QkFDdENBLEtBQUlBLENBQUNBLFFBQVFBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLDRCQUFtQkEsQ0FBQ0EsS0FBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ3ZEQSxDQUFDQTtnQkFDRkEsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7WUFDSEEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsZUFBZUEsSUFBSUEsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzNEQSxJQUFJQSxFQUFFQSxHQUFHQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxRQUFRQSxDQUFDQSxnQkFBZ0JBLENBQUNBLDRCQUFtQkEsRUFBRUEsVUFBQUEsQ0FBQ0E7b0JBQzdFQSxjQUFPQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxLQUFJQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDL0NBLEtBQUlBLENBQUNBLGVBQWVBLENBQUNBLFFBQVFBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ3ZEQSxDQUFDQSxDQUFDQSxDQUFBQTtZQUNIQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFBQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxJQUFJQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDdERBLElBQUlBLEVBQUVBLEdBQUdBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsOEJBQXFCQSxFQUFFQSxVQUFBQSxDQUFDQTtvQkFDL0RBLGNBQU9BLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEtBQUlBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLEtBQUlBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO29CQUMvQ0EsS0FBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtnQkFDdkNBLENBQUNBLENBQUNBLENBQUFBO1lBQ0hBLENBQUNBO1FBMkJGQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFBQSxNQUFNQTtZQUM1QkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBSUEsRUFBRUEsS0FBSUEsQ0FBQ0EsQ0FBQ0E7UUFDekJBLENBQUNBLENBQUNBLENBQUFBO1FBRUZBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBO0lBR2hCQSxDQUFDQTtJQTRCd0MsdUJBQWUsbUJBNUJ2RDtJQUVEO1FBQUFDLGlCQVNDQTtRQVJBQSxFQUFFQSxDQUFBQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxJQUFJQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxJQUFJQSxDQUFDQTtZQUNwREEsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsOEJBQXFCQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUV6RUEsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBQUEsTUFBTUE7WUFDN0JBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEtBQUlBLEVBQUVBLEtBQUlBLENBQUNBLENBQUNBO1FBQ3pCQSxDQUFDQSxDQUFDQSxDQUFBQTtRQUVGQSxJQUFJQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQTtJQUNqQkEsQ0FBQ0E7SUFpQnlELHdCQUFnQixvQkFqQnpFO0lBRUQ7UUFBQUMsaUJBS0NBO1FBSkFBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLFVBQUFBLE1BQU1BO1lBQzdCQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFJQSxFQUFFQSxLQUFJQSxDQUFDQSxDQUFDQTtRQUN6QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7UUFDRkEsSUFBSUEsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0E7SUFDakJBLENBQUNBO0lBVTJFLHdCQUFnQixvQkFWM0Y7SUFFRCx1QkFBdUIsSUFBUTtRQUM5QkMsT0FBTUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0E7WUFDOUJBLEVBQUVBLENBQUFBLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLElBQUlBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO2dCQUNqREEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDZEEsQ0FBQ0E7UUFDREEsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7SUFDZEEsQ0FBQ0E7SUFFNEYiLCJmaWxlIjoiY29tcG9uZW50L3JlZ2lzdGVyL3Byb3RvdHlwZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RXZlbnRCdXN9IGZyb20gXCJob3JjcnV4LWV2ZW50XCJcclxuaW1wb3J0IHtnZXR9IGZyb20gXCJob3JjcnV4LWRpXCJcclxuXHJcbmltcG9ydCB7Q29tcG9uZW50Q3JlYXRlZEV2ZW50LCBDb21wb25lbnRSZWFkeUV2ZW50LCBDb21wb25lbnRDYW5CaW5kRXZlbnR9IGZyb20gXCIuL2V2ZW50c1wiXHJcbmltcG9ydCB7Q29tcG9uZW50UmVnaXN0cnl9IGZyb20gXCIuLi9jb21wb25lbnRyZWdpc3RyeVwiXHJcbmltcG9ydCB7RWxlbWVudFJlZ2lzdGVyZWR9IGZyb20gXCIuL3JlZ2lzdGVyXCJcclxuaW1wb3J0IHtiaW5kRG9tfSBmcm9tIFwiLi4vLi4vYmluZC9iaW5kXCJcclxuXHJcbi8qKlxyXG4gKiBDcmVhdGVzIGEgbmV3IEhUTUxFbGVtZW50LnByb3RvdHlwZSwgYXNzaWducyBhbGwgcHJvcGVydGllcyBvZiAnbmV3IHRhcmdldCgpJyB0byBpdCBhbmQgcmV0dXJucyBpdDsgXHJcbiAqL1xyXG5mdW5jdGlvbiBjcmVhdGVQcm90b3R5cGUodGFyZ2V0OmFueSk6IGFueSB7XHJcblx0bGV0IHByb3RvID0gT2JqZWN0LmNyZWF0ZShIVE1MRWxlbWVudC5wcm90b3R5cGUpO1xyXG5cdFxyXG5cdGZ1bmN0aW9uIGcocCwgaykge1xyXG4gICAgICAgIFx0ZG8ge2lmKHAuaGFzT3duUHJvcGVydHkoaykpIHJldHVybiBwOyBlbHNlIHAgPSAocC5wcm90b3R5cGUgfHwgcC5fX3Byb3RvX18pfSB3aGlsZSh0cnVlKVxyXG4gICAgICAgIH1cclxuXHRmb3IodmFyIGtleSBpbiB0YXJnZXQucHJvdG90eXBlKSB7XHJcblx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvdG8sIGtleSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihnKHRhcmdldC5wcm90b3R5cGUsIGtleSksIGtleSkpO1xyXG5cdH1cclxuXHRcclxuXHQvKlxyXG5cdGxldCB0ID0gdGFyZ2V0O1xyXG5cdGRvIHtcclxuXHRcdHQgPSB0LnByb3RvdHlwZSB8fCB0Ll9fcHJvdG9fXztcclxuXHRcdE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHQpXHJcblx0XHQuZm9yRWFjaChrZXkgPT4ge1xyXG5cdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvdG8sIGtleSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCBrZXkpKTtcclxuXHRcdH0pXHJcblx0fSB3aGlsZSghISh0LnByb3RvdHlwZSB8fCB0Ll9fcHJvdG9fXykpXHJcblx0XHJcblx0Zm9yKGxldCBrZXkgaW4gdGFyZ2V0LnByb3RvdHlwZSlcclxuXHRcdHByb3RvW2tleV0gPSB0YXJnZXQucHJvdG90eXBlW2tleV07XHJcblx0Ki9cclxuXHRyZXR1cm4gcHJvdG87XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBZGRzIGEgZnVuY3Rpb24gbmFtZWQgJ2tleScgdG8gJ3RhcmdldCcsIHdoaWNoIGlzIGEgZnVuY3Rpb24gdGhhdCBjYWxscyAnY2InIHdpdGggZ2l2ZW4gJ2FyZ3MnXHJcbiAqIGFuZCB0aGVuIGNhbGxzIHRoZSBwcmV2aW91cyAndGFyZ2V0W2tleV0nIGlmIGl0IHdhcyBhIGZ1bmN0aW9uIHdpdGggJ2FyZ3MnLiBcclxuICovXHJcbmZ1bmN0aW9uIGFzc2lnbkNhbGxiYWNrKHRhcmdldDphbnksIGtleTpzdHJpbmcsIGNiOkZ1bmN0aW9uLCBhcmdzPVtdKTogdm9pZCB7XHJcblx0bGV0IG9yaWdpbmFsID0gdGFyZ2V0W2tleV07XHJcblx0dGFyZ2V0W2tleV0gPSBmdW5jdGlvbigpIHtcclxuXHRcdGNiLmFwcGx5KHRoaXMsIGFyZ3MpO1xyXG5cdFx0dHlwZW9mIG9yaWdpbmFsID09PSBcImZ1bmN0aW9uXCIgPyBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogJyc7XHJcblx0fVxyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIERlZmF1bHQgJ2NyZWF0ZWRDYWxsYmFjaycgZm9yIGEgQ3VzdG9tZWxlbWVudC4gQXBwZW5kcyB0aGUgJ3RlbXBsYXRlJyBjb250ZW50IHRvIHNoYWRvd3Jvb3QsIGlmICEhdGVtcGxhdGVcclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZWRDYWxsYmFjayh0ZW1wbGF0ZTphbnksIHRhcmdldDphbnkpOnZvaWQge1xyXG5cdFxyXG5cdHRhcmdldC5jYWxsKHRoaXMpO1xyXG5cdFxyXG5cdGlmKCEhdGVtcGxhdGUpIHtcclxuXHRcdGxldCBzaGFkb3cgPSB0aGlzLmNyZWF0ZVNoYWRvd1Jvb3QoKTtcclxuXHRcdGxldCBjbG9uZSA9IGRvY3VtZW50LmltcG9ydE5vZGUodGVtcGxhdGUuY29udGVudCwgdHJ1ZSk7XHJcblx0XHRzaGFkb3cuYXBwZW5kQ2hpbGQoY2xvbmUpO1xyXG5cdFx0XHJcblx0XHRsZXQgd2MgPSB3aW5kb3dbXCJXZWJDb21wb25lbnRzXCJdO1xyXG5cdFx0aWYod2MgJiYgd2MuU2hhZG93Q1NTKVxyXG5cdFx0XHR3Yy5TaGFkb3dDU1Muc2hpbVN0eWxpbmcodGVtcGxhdGUuY29udGVudCwgdGFyZ2V0LnNlbGVjdG9yLCBcIlwiKTtcclxuXHRcdFxyXG5cdFx0XHRcclxuXHRcdGlmKHRlbXBsYXRlLmhhc0F0dHJpYnV0ZShcImxhenlcIikpXHJcblx0XHRcdHRoaXMubGF6eSA9IHRydWU7XHJcblx0XHRcclxuXHRcdGlmKCF0aGlzLmxhenkgJiYgISh0aGlzLnBhcmVudENvbXBvbmVudCAmJiB0aGlzLnBhcmVudENvbXBvbmVudC5sYXp5KSAmJiAhaGFzTGF6eVBhcmVudCh0aGlzKSlcclxuXHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXS5jb25jYXQodGhpcy5hbmNlc3RvcnMpKTtcclxuXHRcdGVsc2UgaWYodGhpcy5sYXp5KXtcclxuXHRcdFx0bGV0IHVuY3JlYXRlZCA9IFtdLmZpbHRlci5jYWxsKHNoYWRvdy5xdWVyeVNlbGVjdG9yQWxsKFwiKlwiKSwgZWxlbWVudCA9PiB7cmV0dXJuIGVsZW1lbnQubm9kZU5hbWUuaW5kZXhPZihcIi1cIikgPiAtMX0pO1xyXG5cdFx0XHRsZXQgaWQgPSB0aGlzLmV2ZW50QnVzLmFkZEV2ZW50TGlzdGVuZXIoQ29tcG9uZW50Q3JlYXRlZEV2ZW50LCBlID0+IHtcclxuXHRcdFx0XHRsZXQgaW5kZXggPSB1bmNyZWF0ZWQuaW5kZXhPZihlLmRhdGEpO1xyXG5cdFx0XHRcdGlmKGluZGV4ID4gLTEpIHVuY3JlYXRlZC5zcGxpY2UoaW5kZXgsIDEpO1xyXG5cdFx0XHRcdGlmKHVuY3JlYXRlZC5sZW5ndGggPT0gMCkge1xyXG5cdFx0XHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXS5jb25jYXQodGhpcy5hbmNlc3RvcnMpKTtcclxuXHRcdFx0XHRcdHRoaXMuZXZlbnRCdXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihpZCk7XHJcblx0XHRcdFx0XHR0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKG5ldyBDb21wb25lbnRSZWFkeUV2ZW50KHRoaXMpKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pXHJcblx0XHR9XHJcblx0XHRlbHNlIGlmKHRoaXMucGFyZW50Q29tcG9uZW50ICYmIHRoaXMucGFyZW50Q29tcG9uZW50LmxhenkpIHtcclxuXHRcdFx0bGV0IGlkID0gdGhpcy5wYXJlbnRDb21wb25lbnQuZXZlbnRCdXMuYWRkRXZlbnRMaXN0ZW5lcihDb21wb25lbnRSZWFkeUV2ZW50LCBlID0+IHtcclxuXHRcdFx0XHRiaW5kRG9tKHNoYWRvdywgW3RoaXNdLmNvbmNhdCh0aGlzLmFuY2VzdG9ycykpO1xyXG5cdFx0XHRcdHRoaXMucGFyZW50Q29tcG9uZW50LmV2ZW50QnVzLnJlbW92ZUV2ZW50TGlzdGVuZXIoaWQpO1xyXG5cdFx0XHR9KVxyXG5cdFx0fVxyXG5cdFx0ZWxzZSBpZighdGhpcy5wYXJlbnRDb21wb25lbnQgJiYgaGFzTGF6eVBhcmVudCh0aGlzKSkge1xyXG5cdFx0XHRsZXQgaWQgPSB0aGlzLmV2ZW50QnVzLmFkZEV2ZW50TGlzdGVuZXIoQ29tcG9uZW50Q2FuQmluZEV2ZW50LCBlID0+IHtcclxuXHRcdFx0XHRiaW5kRG9tKHNoYWRvdywgW3RoaXNdLmNvbmNhdCh0aGlzLmFuY2VzdG9ycykpO1xyXG5cdFx0XHRcdHRoaXMuZXZlbnRCdXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihpZCk7XHJcblx0XHRcdH0pXHJcblx0XHR9XHJcblx0XHRcclxuXHRcdC8qXHJcblx0XHRsZXQgdW5yZXNvbHZlZCA9IFtdLmZpbHRlci5jYWxsKHNoYWRvdy5xdWVyeVNlbGVjdG9yQWxsKFwiKlt3YWl0XVwiKSwgZWxlbWVudCA9PiB7XHJcblx0XHRcdHJldHVybiAhKGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBpbiBDb21wb25lbnRSZWdpc3RyeSk7XHJcblx0XHR9KS5tYXAoZWxlbWVudCA9PiB7XHJcblx0XHRcdHJldHVybiBlbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7XHJcblx0XHR9KVxyXG5cdFx0LnNvcnQoKVxyXG5cdFx0LnJlZHVjZSgoYSwgYikgPT4geyBpZiAoYiAhPSBhWzBdKSBhLnVuc2hpZnQoYik7IHJldHVybiBhIH0sIFtdKTtcclxuXHRcdFxyXG5cdFx0aWYodW5yZXNvbHZlZC5sZW5ndGggPiAwKSB7XHJcblx0XHRcdGxldCBlYiA9IGdldChFdmVudEJ1cyk7XHJcblx0XHRcdGxldCBpZCA9IGViLmFkZEV2ZW50TGlzdGVuZXIoRWxlbWVudFJlZ2lzdGVyZWQsIGUgPT4ge1xyXG5cdFx0XHRcdGxldCBpbmRleCA9IHVucmVzb2x2ZWQuaW5kZXhPZihlLmRhdGEpO1xyXG5cdFx0XHRcdGlmKGluZGV4ID09PSAtMSkgcmV0dXJuO1xyXG5cdFx0XHRcdHVucmVzb2x2ZWQuc3BsaWNlKGluZGV4LCAxKTtcclxuXHRcdFx0XHRpZih1bnJlc29sdmVkLmxlbmd0aCA9PT0gMCkge1xyXG5cdFx0XHRcdFx0ZWIucmVtb3ZlRXZlbnRMaXN0ZW5lcihFbGVtZW50UmVnaXN0ZXJlZCwgaWQpO1xyXG5cdFx0XHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXSk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9KTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGJpbmREb20oc2hhZG93LCBbdGhpc10pO1xyXG5cdFx0fVxyXG5cdFx0Ki9cclxuXHRcdFxyXG5cdH1cclxuXHRcclxuXHR0aGlzLm9uQ3JlYXRlZC5mb3JFYWNoKG1ldGhvZCA9PiB7XHJcblx0XHRtZXRob2QuY2FsbCh0aGlzLCB0aGlzKTtcclxuXHR9KVxyXG5cdFxyXG5cdHRoaXMuY3JlYXRlZCgpO1xyXG5cdFxyXG5cdFxyXG59XHJcblxyXG5mdW5jdGlvbiBhdHRhY2hlZENhbGxiYWNrKCk6IHZvaWQge1xyXG5cdGlmKHRoaXMucGFyZW50Q29tcG9uZW50ICYmIHRoaXMucGFyZW50Q29tcG9uZW50LmxhenkpXHJcblx0XHR0aGlzLnBhcmVudENvbXBvbmVudC5ldmVudEJ1cy5kaXNwYXRjaChuZXcgQ29tcG9uZW50Q3JlYXRlZEV2ZW50KHRoaXMpKTtcclxuXHRcclxuXHR0aGlzLm9uQXR0YWNoZWQuZm9yRWFjaChtZXRob2QgPT4ge1xyXG5cdFx0bWV0aG9kLmNhbGwodGhpcywgdGhpcyk7XHJcblx0fSlcclxuXHRcclxuXHR0aGlzLmF0dGFjaGVkKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRldGFjaGVkQ2FsbGJhY2soKTogdm9pZCB7XHJcblx0dGhpcy5vbkRldGFjaGVkLmZvckVhY2gobWV0aG9kID0+IHtcclxuXHRcdG1ldGhvZC5jYWxsKHRoaXMsIHRoaXMpO1xyXG5cdH0pXHJcblx0dGhpcy5kZXRhY2hlZCgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBoYXNMYXp5UGFyZW50KG5vZGU6YW55KTogYm9vbGVhbiB7XHJcblx0d2hpbGUobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkge1xyXG5cdFx0aWYobm9kZS5oYXNBdHRyaWJ1dGUgJiYgbm9kZS5oYXNBdHRyaWJ1dGUoXCJsYXp5XCIpKVxyXG5cdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHR9XHJcblx0cmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5leHBvcnQge2NyZWF0ZVByb3RvdHlwZSwgYXNzaWduQ2FsbGJhY2ssIGNyZWF0ZWRDYWxsYmFjaywgYXR0YWNoZWRDYWxsYmFjaywgZGV0YWNoZWRDYWxsYmFja30iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=