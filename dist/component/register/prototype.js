define(["require", "exports", "./events", "../../bind/bind"], function (require, exports, events_1, bind_1) {
    /**
     * Creates a new HTMLElement.prototype, assigns all properties of 'new target()' to it and returns it;
     */
    function createPrototype(target) {
        var proto = Object.create(HTMLElement.prototype);
        function g(p, k) {
            do {
                if (p.hasOwnProperty(k))
                    return p;
                else
                    p = (p.prototype || p.__proto__);
            } while (true);
        }
        for (var key in target.prototype) {
            Object.defineProperty(proto, key, Object.getOwnPropertyDescriptor(g(target.prototype, key), key));
        }
        /*
        let t = target;
        do {
            t = t.prototype || t.__proto__;
            Object.getOwnPropertyNames(t)
            .forEach(key => {
                Object.defineProperty(proto, key, Object.getOwnPropertyDescriptor(t, key));
            })
        } while(!!(t.prototype || t.__proto__))
        
        for(let key in target.prototype)
            proto[key] = target.prototype[key];
        */
        return proto;
    }
    exports.createPrototype = createPrototype;
    /**
     * Adds a function named 'key' to 'target', which is a function that calls 'cb' with given 'args'
     * and then calls the previous 'target[key]' if it was a function with 'args'.
     */
    function assignCallback(target, key, cb, args) {
        if (args === void 0) { args = []; }
        var original = target[key];
        target[key] = function () {
            cb.apply(this, args);
            typeof original === "function" ? original.apply(this, arguments) : '';
        };
    }
    exports.assignCallback = assignCallback;
    /**
     * Default 'createdCallback' for a Customelement. Appends the 'template' content to shadowroot, if !!template
     */
    function createdCallback(template, target) {
        var _this = this;
        target.call(this);
        if (!!template) {
            var shadow = this.createShadowRoot();
            var clone = document.importNode(template.content, true);
            shadow.appendChild(clone);
            var wc = window["WebComponents"];
            if (wc && wc.ShadowCSS)
                wc.ShadowCSS.shimStyling(template.content, target.selector, "");
            if (template.hasAttribute("lazy") || this.hasAttribute("lazy"))
                this.lazy = true;
            if (!this.lazy && !(this.parentComponent && this.parentComponent.lazy) && !hasLazyParent(this))
                bind_1.bindDom(shadow, [this].concat(this.ancestors));
            else if (this.lazy) {
                var id1, id2;
                var uncreated = [].filter.call(shadow.querySelectorAll("*"), function (element) { return element.nodeName.indexOf("-") > -1; });
                id1 = this.eventBus.addEventListener(events_1.ComponentCreatedEvent, function (e) {
                    var index = uncreated.indexOf(e.data);
                    if (index > -1)
                        uncreated.splice(index, 1);
                    if (uncreated.length == 0) {
                        try {
                            _this.eventBus.removeEventListener(id1);
                            _this.eventBus.removeEventListener(id2);
                        }
                        catch (e) { }
                        bind_1.bindDom(shadow, [_this].concat(_this.ancestors));
                        _this.eventBus.dispatch(new events_1.ComponentReadyEvent(_this));
                    }
                });
                id2 = this.eventBus.addEventListener(events_1.ComponentCanBindEvent, function (e) {
                    try {
                        _this.eventBus.removeEventListener(id1);
                        _this.eventBus.removeEventListener(id2);
                    }
                    catch (e) { }
                    bind_1.bindDom(shadow, [_this].concat(_this.ancestors).concat(!!e.data ? e.data : []));
                });
            }
            else if (this.parentComponent && this.parentComponent.lazy) {
                var id = this.parentComponent.eventBus.addEventListener(events_1.ComponentReadyEvent, function (e) {
                    bind_1.bindDom(shadow, [_this].concat(_this.ancestors));
                    _this.parentComponent && _this.parentComponent.eventBus.removeEventListener(id);
                });
            }
            else if (!this.parentComponent && hasLazyParent(this)) {
                var id = this.eventBus.addEventListener(events_1.ComponentCanBindEvent, function (e) {
                    bind_1.bindDom(shadow, [_this].concat(_this.ancestors).concat(!!e.data ? e.data : []));
                    _this.eventBus.removeEventListener(id);
                });
            }
        }
        this.onCreated.forEach(function (method) {
            method.call(_this, _this);
        });
        this.created();
    }
    exports.createdCallback = createdCallback;
    function attachedCallback() {
        var _this = this;
        if (!!this.lazy)
            this.eventBus.dispatch(new events_1.ComponentCreatedEvent(this));
        if (this.parentComponent && this.parentComponent.lazy)
            this.parentComponent.eventBus.dispatch(new events_1.ComponentCreatedEvent(this));
        this.onAttached.forEach(function (method) {
            method.call(_this, _this);
        });
        this.attached();
    }
    exports.attachedCallback = attachedCallback;
    function detachedCallback() {
        var _this = this;
        this.onDetached.forEach(function (method) {
            method.call(_this, _this);
        });
        this.detached();
    }
    exports.detachedCallback = detachedCallback;
    function hasLazyParent(node) {
        while (node = node.parentNode) {
            if (node.hasAttribute && node.hasAttribute("lazy"))
                return true;
        }
        return false;
    }
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudC9yZWdpc3Rlci9wcm90b3R5cGUudHMiXSwibmFtZXMiOlsiY3JlYXRlUHJvdG90eXBlIiwiY3JlYXRlUHJvdG90eXBlLmciLCJhc3NpZ25DYWxsYmFjayIsImNyZWF0ZWRDYWxsYmFjayIsImF0dGFjaGVkQ2FsbGJhY2siLCJkZXRhY2hlZENhbGxiYWNrIiwiaGFzTGF6eVBhcmVudCJdLCJtYXBwaW5ncyI6IjtJQVFBOztPQUVHO0lBQ0gseUJBQXlCLE1BQVU7UUFDbENBLElBQUlBLEtBQUtBLEdBQUdBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBO1FBRWpEQSxXQUFXQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUNQQyxHQUFHQSxDQUFDQTtnQkFBQUEsRUFBRUEsQ0FBQUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO2dCQUFDQSxJQUFJQTtvQkFBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsU0FBU0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQUE7WUFBQUEsQ0FBQ0EsUUFBT0EsSUFBSUEsRUFBQ0E7UUFDekZBLENBQUNBO1FBQ1JELEdBQUdBLENBQUFBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBQ2pDQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQSxLQUFLQSxFQUFFQSxHQUFHQSxFQUFFQSxNQUFNQSxDQUFDQSx3QkFBd0JBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLEVBQUVBLEdBQUdBLENBQUNBLEVBQUVBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1FBQ25HQSxDQUFDQTtRQUVEQTs7Ozs7Ozs7Ozs7O1VBWUVBO1FBQ0ZBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0lBQ2RBLENBQUNBO0lBMklPLHVCQUFlLG1CQTNJdEI7SUFFRDs7O09BR0c7SUFDSCx3QkFBd0IsTUFBVSxFQUFFLEdBQVUsRUFBRSxFQUFXLEVBQUUsSUFBTztRQUFQRSxvQkFBT0EsR0FBUEEsU0FBT0E7UUFDbkVBLElBQUlBLFFBQVFBLEdBQUdBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQzNCQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQTtZQUNiLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3JCLE9BQU8sUUFBUSxLQUFLLFVBQVUsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDdkUsQ0FBQyxDQUFBQTtJQUNGQSxDQUFDQTtJQStId0Isc0JBQWMsa0JBL0h0QztJQUdEOztPQUVHO0lBQ0gseUJBQXlCLFFBQVksRUFBRSxNQUFVO1FBQWpEQyxpQkEwRkNBO1FBeEZBQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUVsQkEsRUFBRUEsQ0FBQUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDZkEsSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxFQUFFQSxDQUFDQTtZQUNyQ0EsSUFBSUEsS0FBS0EsR0FBR0EsUUFBUUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDeERBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBRTFCQSxJQUFJQSxFQUFFQSxHQUFHQSxNQUFNQSxDQUFDQSxlQUFlQSxDQUFDQSxDQUFDQTtZQUNqQ0EsRUFBRUEsQ0FBQUEsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsQ0FBQ0EsU0FBU0EsQ0FBQ0E7Z0JBQ3JCQSxFQUFFQSxDQUFDQSxTQUFTQSxDQUFDQSxXQUFXQSxDQUFDQSxRQUFRQSxDQUFDQSxPQUFPQSxFQUFFQSxNQUFNQSxDQUFDQSxRQUFRQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFDQTtZQUdqRUEsRUFBRUEsQ0FBQUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7Z0JBQzdEQSxJQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtZQUVsQkEsRUFBRUEsQ0FBQUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsZUFBZUEsSUFBSUEsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQzdGQSxjQUFPQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNoREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQUEsQ0FBQ0E7Z0JBQ2xCQSxJQUFJQSxHQUFHQSxFQUFFQSxHQUFHQSxDQUFDQTtnQkFDYkEsSUFBSUEsU0FBU0EsR0FBR0EsRUFBRUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxVQUFBQSxPQUFPQSxJQUFLQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFBQSxDQUFBQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDckhBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLGdC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Q0EsSUFBSUEsQ0FBQ0E7WUFDcERBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLFFBQVFBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLDhCQUFxQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFekVBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLFVBQUFBLE1BQU1BO1lBQzdCQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFJQSxFQUFFQSxLQUFJQSxDQUFDQSxDQUFDQTtRQUN6QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7UUFFRkEsSUFBSUEsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0E7SUFDakJBLENBQUNBO0lBaUJ5RCx3QkFBZ0Isb0JBakJ6RTtJQUVEO1FBQUFDLGlCQUtDQTtRQUpBQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFBQSxNQUFNQTtZQUM3QkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBSUEsRUFBRUEsS0FBSUEsQ0FBQ0EsQ0FBQ0E7UUFDekJBLENBQUNBLENBQUNBLENBQUFBO1FBQ0ZBLElBQUlBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBO0lBQ2pCQSxDQUFDQTtJQVUyRSx3QkFBZ0Isb0JBVjNGO0lBRUQsdUJBQXVCLElBQVE7UUFDOUJDLE9BQU1BLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBO1lBQzlCQSxFQUFFQSxDQUFBQSxDQUFDQSxJQUFJQSxDQUFDQSxZQUFZQSxJQUFJQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtnQkFDakRBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBQ2RBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0lBQ2RBLENBQUNBO0lBRTRGIiwiZmlsZSI6ImNvbXBvbmVudC9yZWdpc3Rlci9wcm90b3R5cGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0V2ZW50QnVzfSBmcm9tIFwiaG9yY3J1eC1ldmVudFwiXHJcbmltcG9ydCB7Z2V0fSBmcm9tIFwiaG9yY3J1eC1kaVwiXHJcblxyXG5pbXBvcnQge0NvbXBvbmVudENyZWF0ZWRFdmVudCwgQ29tcG9uZW50UmVhZHlFdmVudCwgQ29tcG9uZW50Q2FuQmluZEV2ZW50fSBmcm9tIFwiLi9ldmVudHNcIlxyXG5pbXBvcnQge0NvbXBvbmVudFJlZ2lzdHJ5fSBmcm9tIFwiLi4vY29tcG9uZW50cmVnaXN0cnlcIlxyXG5pbXBvcnQge0VsZW1lbnRSZWdpc3RlcmVkfSBmcm9tIFwiLi9yZWdpc3RlclwiXHJcbmltcG9ydCB7YmluZERvbX0gZnJvbSBcIi4uLy4uL2JpbmQvYmluZFwiXHJcblxyXG4vKipcclxuICogQ3JlYXRlcyBhIG5ldyBIVE1MRWxlbWVudC5wcm90b3R5cGUsIGFzc2lnbnMgYWxsIHByb3BlcnRpZXMgb2YgJ25ldyB0YXJnZXQoKScgdG8gaXQgYW5kIHJldHVybnMgaXQ7IFxyXG4gKi9cclxuZnVuY3Rpb24gY3JlYXRlUHJvdG90eXBlKHRhcmdldDphbnkpOiBhbnkge1xyXG5cdGxldCBwcm90byA9IE9iamVjdC5jcmVhdGUoSFRNTEVsZW1lbnQucHJvdG90eXBlKTtcclxuXHRcclxuXHRmdW5jdGlvbiBnKHAsIGspIHtcclxuICAgICAgICBcdGRvIHtpZihwLmhhc093blByb3BlcnR5KGspKSByZXR1cm4gcDsgZWxzZSBwID0gKHAucHJvdG90eXBlIHx8IHAuX19wcm90b19fKX0gd2hpbGUodHJ1ZSlcclxuICAgICAgICB9XHJcblx0Zm9yKHZhciBrZXkgaW4gdGFyZ2V0LnByb3RvdHlwZSkge1xyXG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZyh0YXJnZXQucHJvdG90eXBlLCBrZXkpLCBrZXkpKTtcclxuXHR9XHJcblx0XHJcblx0LypcclxuXHRsZXQgdCA9IHRhcmdldDtcclxuXHRkbyB7XHJcblx0XHR0ID0gdC5wcm90b3R5cGUgfHwgdC5fX3Byb3RvX187XHJcblx0XHRPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0KVxyXG5cdFx0LmZvckVhY2goa2V5ID0+IHtcclxuXHRcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwga2V5KSk7XHJcblx0XHR9KVxyXG5cdH0gd2hpbGUoISEodC5wcm90b3R5cGUgfHwgdC5fX3Byb3RvX18pKVxyXG5cdFxyXG5cdGZvcihsZXQga2V5IGluIHRhcmdldC5wcm90b3R5cGUpXHJcblx0XHRwcm90b1trZXldID0gdGFyZ2V0LnByb3RvdHlwZVtrZXldO1xyXG5cdCovXHJcblx0cmV0dXJuIHByb3RvO1xyXG59XHJcblxyXG4vKipcclxuICogQWRkcyBhIGZ1bmN0aW9uIG5hbWVkICdrZXknIHRvICd0YXJnZXQnLCB3aGljaCBpcyBhIGZ1bmN0aW9uIHRoYXQgY2FsbHMgJ2NiJyB3aXRoIGdpdmVuICdhcmdzJ1xyXG4gKiBhbmQgdGhlbiBjYWxscyB0aGUgcHJldmlvdXMgJ3RhcmdldFtrZXldJyBpZiBpdCB3YXMgYSBmdW5jdGlvbiB3aXRoICdhcmdzJy4gXHJcbiAqL1xyXG5mdW5jdGlvbiBhc3NpZ25DYWxsYmFjayh0YXJnZXQ6YW55LCBrZXk6c3RyaW5nLCBjYjpGdW5jdGlvbiwgYXJncz1bXSk6IHZvaWQge1xyXG5cdGxldCBvcmlnaW5hbCA9IHRhcmdldFtrZXldO1xyXG5cdHRhcmdldFtrZXldID0gZnVuY3Rpb24oKSB7XHJcblx0XHRjYi5hcHBseSh0aGlzLCBhcmdzKTtcclxuXHRcdHR5cGVvZiBvcmlnaW5hbCA9PT0gXCJmdW5jdGlvblwiID8gb3JpZ2luYWwuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6ICcnO1xyXG5cdH1cclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiBEZWZhdWx0ICdjcmVhdGVkQ2FsbGJhY2snIGZvciBhIEN1c3RvbWVsZW1lbnQuIEFwcGVuZHMgdGhlICd0ZW1wbGF0ZScgY29udGVudCB0byBzaGFkb3dyb290LCBpZiAhIXRlbXBsYXRlXHJcbiAqL1xyXG5mdW5jdGlvbiBjcmVhdGVkQ2FsbGJhY2sodGVtcGxhdGU6YW55LCB0YXJnZXQ6YW55KTp2b2lkIHtcclxuXHRcclxuXHR0YXJnZXQuY2FsbCh0aGlzKTtcclxuXHRcclxuXHRpZighIXRlbXBsYXRlKSB7XHJcblx0XHRsZXQgc2hhZG93ID0gdGhpcy5jcmVhdGVTaGFkb3dSb290KCk7XHJcblx0XHRsZXQgY2xvbmUgPSBkb2N1bWVudC5pbXBvcnROb2RlKHRlbXBsYXRlLmNvbnRlbnQsIHRydWUpO1xyXG5cdFx0c2hhZG93LmFwcGVuZENoaWxkKGNsb25lKTtcclxuXHRcdFxyXG5cdFx0bGV0IHdjID0gd2luZG93W1wiV2ViQ29tcG9uZW50c1wiXTtcclxuXHRcdGlmKHdjICYmIHdjLlNoYWRvd0NTUylcclxuXHRcdFx0d2MuU2hhZG93Q1NTLnNoaW1TdHlsaW5nKHRlbXBsYXRlLmNvbnRlbnQsIHRhcmdldC5zZWxlY3RvciwgXCJcIik7XHJcblx0XHRcclxuXHRcdFx0XHJcblx0XHRpZih0ZW1wbGF0ZS5oYXNBdHRyaWJ1dGUoXCJsYXp5XCIpIHx8IHRoaXMuaGFzQXR0cmlidXRlKFwibGF6eVwiKSlcclxuXHRcdFx0dGhpcy5sYXp5ID0gdHJ1ZTtcclxuXHRcdFxyXG5cdFx0aWYoIXRoaXMubGF6eSAmJiAhKHRoaXMucGFyZW50Q29tcG9uZW50ICYmIHRoaXMucGFyZW50Q29tcG9uZW50LmxhenkpICYmICFoYXNMYXp5UGFyZW50KHRoaXMpKVxyXG5cdFx0XHRiaW5kRG9tKHNoYWRvdywgW3RoaXNdLmNvbmNhdCh0aGlzLmFuY2VzdG9ycykpO1xyXG5cdFx0ZWxzZSBpZih0aGlzLmxhenkpe1xyXG5cdFx0XHRsZXQgaWQxLCBpZDI7XHJcblx0XHRcdGxldCB1bmNyZWF0ZWQgPSBbXS5maWx0ZXIuY2FsbChzaGFkb3cucXVlcnlTZWxlY3RvckFsbChcIipcIiksIGVsZW1lbnQgPT4ge3JldHVybiBlbGVtZW50Lm5vZGVOYW1lLmluZGV4T2YoXCItXCIpID4gLTF9KTtcclxuXHRcdFx0aWQxID0gdGhpcy5ldmVudEJ1cy5hZGRFdmVudExpc3RlbmVyKENvbXBvbmVudENyZWF0ZWRFdmVudCwgZSA9PiB7XHJcblx0XHRcdFx0bGV0IGluZGV4ID0gdW5jcmVhdGVkLmluZGV4T2YoZS5kYXRhKTtcclxuXHRcdFx0XHRpZihpbmRleCA+IC0xKSB1bmNyZWF0ZWQuc3BsaWNlKGluZGV4LCAxKTtcclxuXHRcdFx0XHRpZih1bmNyZWF0ZWQubGVuZ3RoID09IDApIHtcclxuXHRcdFx0XHRcdHRyeSB7XHJcblx0XHRcdFx0XHRcdHRoaXMuZXZlbnRCdXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihpZDEpXHJcblx0XHRcdFx0XHRcdHRoaXMuZXZlbnRCdXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihpZDIpO1xyXG5cdFx0XHRcdFx0fSBjYXRjaChlKSB7fVxyXG5cdFx0XHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXS5jb25jYXQodGhpcy5hbmNlc3RvcnMpKTtcclxuXHRcdFx0XHRcdHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2gobmV3IENvbXBvbmVudFJlYWR5RXZlbnQodGhpcykpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSlcclxuXHRcdFx0aWQyID0gdGhpcy5ldmVudEJ1cy5hZGRFdmVudExpc3RlbmVyKENvbXBvbmVudENhbkJpbmRFdmVudCwgZSA9PiB7XHJcblx0XHRcdFx0dHJ5IHtcclxuXHRcdFx0XHRcdHRoaXMuZXZlbnRCdXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihpZDEpXHJcblx0XHRcdFx0XHR0aGlzLmV2ZW50QnVzLnJlbW92ZUV2ZW50TGlzdGVuZXIoaWQyKTtcclxuXHRcdFx0XHR9IGNhdGNoKGUpIHt9XHJcblx0XHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXS5jb25jYXQodGhpcy5hbmNlc3RvcnMpLmNvbmNhdCghIWUuZGF0YSA/IGUuZGF0YSA6IFtdKSk7XHJcblx0XHRcdH0pXHJcblx0XHRcdFxyXG5cdFx0fVxyXG5cdFx0ZWxzZSBpZih0aGlzLnBhcmVudENvbXBvbmVudCAmJiB0aGlzLnBhcmVudENvbXBvbmVudC5sYXp5KSB7XHJcblx0XHRcdGxldCBpZCA9IHRoaXMucGFyZW50Q29tcG9uZW50LmV2ZW50QnVzLmFkZEV2ZW50TGlzdGVuZXIoQ29tcG9uZW50UmVhZHlFdmVudCwgZSA9PiB7XHJcblx0XHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXS5jb25jYXQodGhpcy5hbmNlc3RvcnMpKTtcclxuXHRcdFx0XHR0aGlzLnBhcmVudENvbXBvbmVudCAmJiB0aGlzLnBhcmVudENvbXBvbmVudC5ldmVudEJ1cy5yZW1vdmVFdmVudExpc3RlbmVyKGlkKTtcclxuXHRcdFx0fSlcclxuXHRcdH1cclxuXHRcdGVsc2UgaWYoIXRoaXMucGFyZW50Q29tcG9uZW50ICYmIGhhc0xhenlQYXJlbnQodGhpcykpIHtcclxuXHRcdFx0bGV0IGlkID0gdGhpcy5ldmVudEJ1cy5hZGRFdmVudExpc3RlbmVyKENvbXBvbmVudENhbkJpbmRFdmVudCwgZSA9PiB7XHJcblx0XHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXS5jb25jYXQodGhpcy5hbmNlc3RvcnMpLmNvbmNhdCghIWUuZGF0YSA/IGUuZGF0YSA6IFtdKSk7XHJcblx0XHRcdFx0dGhpcy5ldmVudEJ1cy5yZW1vdmVFdmVudExpc3RlbmVyKGlkKTtcclxuXHRcdFx0fSlcclxuXHRcdH1cclxuXHRcdFxyXG5cdFx0LypcclxuXHRcdGxldCB1bnJlc29sdmVkID0gW10uZmlsdGVyLmNhbGwoc2hhZG93LnF1ZXJ5U2VsZWN0b3JBbGwoXCIqW3dhaXRdXCIpLCBlbGVtZW50ID0+IHtcclxuXHRcdFx0cmV0dXJuICEoZWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIGluIENvbXBvbmVudFJlZ2lzdHJ5KTtcclxuXHRcdH0pLm1hcChlbGVtZW50ID0+IHtcclxuXHRcdFx0cmV0dXJuIGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTtcclxuXHRcdH0pXHJcblx0XHQuc29ydCgpXHJcblx0XHQucmVkdWNlKChhLCBiKSA9PiB7IGlmIChiICE9IGFbMF0pIGEudW5zaGlmdChiKTsgcmV0dXJuIGEgfSwgW10pO1xyXG5cdFx0XHJcblx0XHRpZih1bnJlc29sdmVkLmxlbmd0aCA+IDApIHtcclxuXHRcdFx0bGV0IGViID0gZ2V0KEV2ZW50QnVzKTtcclxuXHRcdFx0bGV0IGlkID0gZWIuYWRkRXZlbnRMaXN0ZW5lcihFbGVtZW50UmVnaXN0ZXJlZCwgZSA9PiB7XHJcblx0XHRcdFx0bGV0IGluZGV4ID0gdW5yZXNvbHZlZC5pbmRleE9mKGUuZGF0YSk7XHJcblx0XHRcdFx0aWYoaW5kZXggPT09IC0xKSByZXR1cm47XHJcblx0XHRcdFx0dW5yZXNvbHZlZC5zcGxpY2UoaW5kZXgsIDEpO1xyXG5cdFx0XHRcdGlmKHVucmVzb2x2ZWQubGVuZ3RoID09PSAwKSB7XHJcblx0XHRcdFx0XHRlYi5yZW1vdmVFdmVudExpc3RlbmVyKEVsZW1lbnRSZWdpc3RlcmVkLCBpZCk7XHJcblx0XHRcdFx0XHRiaW5kRG9tKHNoYWRvdywgW3RoaXNdKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXSk7XHJcblx0XHR9XHJcblx0XHQqL1xyXG5cdFx0XHJcblx0fVxyXG5cdFxyXG5cdHRoaXMub25DcmVhdGVkLmZvckVhY2gobWV0aG9kID0+IHtcclxuXHRcdG1ldGhvZC5jYWxsKHRoaXMsIHRoaXMpO1xyXG5cdH0pXHJcblx0XHJcblx0dGhpcy5jcmVhdGVkKCk7XHJcblx0XHJcblx0XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGF0dGFjaGVkQ2FsbGJhY2soKTogdm9pZCB7XHJcblx0aWYoISF0aGlzLmxhenkpXHJcblx0XHR0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKG5ldyBDb21wb25lbnRDcmVhdGVkRXZlbnQodGhpcykpO1xyXG5cdFxyXG5cdGlmKHRoaXMucGFyZW50Q29tcG9uZW50ICYmIHRoaXMucGFyZW50Q29tcG9uZW50LmxhenkpXHJcblx0XHR0aGlzLnBhcmVudENvbXBvbmVudC5ldmVudEJ1cy5kaXNwYXRjaChuZXcgQ29tcG9uZW50Q3JlYXRlZEV2ZW50KHRoaXMpKTtcclxuXHRcclxuXHR0aGlzLm9uQXR0YWNoZWQuZm9yRWFjaChtZXRob2QgPT4ge1xyXG5cdFx0bWV0aG9kLmNhbGwodGhpcywgdGhpcyk7XHJcblx0fSlcclxuXHRcclxuXHR0aGlzLmF0dGFjaGVkKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRldGFjaGVkQ2FsbGJhY2soKTogdm9pZCB7XHJcblx0dGhpcy5vbkRldGFjaGVkLmZvckVhY2gobWV0aG9kID0+IHtcclxuXHRcdG1ldGhvZC5jYWxsKHRoaXMsIHRoaXMpO1xyXG5cdH0pXHJcblx0dGhpcy5kZXRhY2hlZCgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBoYXNMYXp5UGFyZW50KG5vZGU6YW55KTogYm9vbGVhbiB7XHJcblx0d2hpbGUobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkge1xyXG5cdFx0aWYobm9kZS5oYXNBdHRyaWJ1dGUgJiYgbm9kZS5oYXNBdHRyaWJ1dGUoXCJsYXp5XCIpKVxyXG5cdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHR9XHJcblx0cmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5leHBvcnQge2NyZWF0ZVByb3RvdHlwZSwgYXNzaWduQ2FsbGJhY2ssIGNyZWF0ZWRDYWxsYmFjaywgYXR0YWNoZWRDYWxsYmFjaywgZGV0YWNoZWRDYWxsYmFja30iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=