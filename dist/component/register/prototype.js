define(["require", "exports", "./events", "../../bind/bind"], function (require, exports, events_1, bind_1) {
    /**
     * Creates a new HTMLElement.prototype, assigns all properties of 'new target()' to it and returns it;
     */
    function createPrototype(target) {
        var proto = Object.create(HTMLElement.prototype);
        function g(p, k) {
            do {
                if (p.hasOwnProperty(k))
                    return p;
                else
                    p = (p.prototype || p.__proto__);
            } while (true);
        }
        for (var key in target.prototype) {
            Object.defineProperty(proto, key, Object.getOwnPropertyDescriptor(g(target.prototype, key), key));
        }
        /*
        let t = target;
        do {
            t = t.prototype || t.__proto__;
            Object.getOwnPropertyNames(t)
            .forEach(key => {
                Object.defineProperty(proto, key, Object.getOwnPropertyDescriptor(t, key));
            })
        } while(!!(t.prototype || t.__proto__))
        
        for(let key in target.prototype)
            proto[key] = target.prototype[key];
        */
        return proto;
    }
    exports.createPrototype = createPrototype;
    /**
     * Adds a function named 'key' to 'target', which is a function that calls 'cb' with given 'args'
     * and then calls the previous 'target[key]' if it was a function with 'args'.
     */
    function assignCallback(target, key, cb, args) {
        if (args === void 0) { args = []; }
        var original = target[key];
        target[key] = function () {
            cb.apply(this, args);
            typeof original === "function" ? original.apply(this, arguments) : '';
        };
    }
    exports.assignCallback = assignCallback;
    /**
     * Default 'createdCallback' for a Customelement. Appends the 'template' content to shadowroot, if !!template
     */
    function createdCallback(template, target) {
        var _this = this;
        target.call(this);
        if (!!template) {
            var shadow = this.createShadowRoot();
            var clone = document.importNode(template.content, true);
            shadow.appendChild(clone);
            var wc = window["WebComponents"];
            if (wc && wc.ShadowCSS)
                wc.ShadowCSS.shimStyling(template.content, target.selector, "");
            if (template.hasAttribute("lazy") || this.hasAttribute("lazy"))
                this.lazy = true;
            if (!this.lazy && !(this.parentComponent && this.parentComponent.lazy) && !hasLazyParent(this))
                bind_1.bindDom(shadow, [this].concat(this.ancestors));
            else if (this.lazy) {
                var uncreated = [].filter.call(shadow.querySelectorAll("*"), function (element) { return element.nodeName.indexOf("-") > -1; });
                var id1 = this.eventBus.addEventListener(events_1.ComponentCreatedEvent, function (e) {
                    var index = uncreated.indexOf(e.data);
                    if (index > -1)
                        uncreated.splice(index, 1);
                    if (uncreated.length == 0) {
                        bind_1.bindDom(shadow, [_this].concat(_this.ancestors));
                        _this.eventBus.removeEventListener(id1);
                        _this.eventBus.dispatch(new events_1.ComponentReadyEvent(_this));
                    }
                });
                var id2 = this.eventBus.addEventListener(events_1.ComponentCanBindEvent, function (e) {
                    bind_1.bindDom(shadow, [_this].concat(_this.ancestors).concat(!!e.data ? e.data : []));
                    _this.eventBus.removeEventListener(id1);
                    _this.eventBus.removeEventListener(id2);
                });
            }
            else if (this.parentComponent && this.parentComponent.lazy) {
                var id = this.parentComponent.eventBus.addEventListener(events_1.ComponentReadyEvent, function (e) {
                    bind_1.bindDom(shadow, [_this].concat(_this.ancestors));
                    _this.parentComponent.eventBus.removeEventListener(id);
                });
            }
            else if (!this.parentComponent && hasLazyParent(this)) {
                var id = this.eventBus.addEventListener(events_1.ComponentCanBindEvent, function (e) {
                    bind_1.bindDom(shadow, [_this].concat(_this.ancestors).concat(!!e.data ? e.data : []));
                    _this.eventBus.removeEventListener(id);
                });
            }
        }
        this.onCreated.forEach(function (method) {
            method.call(_this, _this);
        });
        this.created();
    }
    exports.createdCallback = createdCallback;
    function attachedCallback() {
        var _this = this;
        if (this.parentComponent && this.parentComponent.lazy)
            this.parentComponent.eventBus.dispatch(new events_1.ComponentCreatedEvent(this));
        this.onAttached.forEach(function (method) {
            method.call(_this, _this);
        });
        this.attached();
    }
    exports.attachedCallback = attachedCallback;
    function detachedCallback() {
        var _this = this;
        this.onDetached.forEach(function (method) {
            method.call(_this, _this);
        });
        this.detached();
    }
    exports.detachedCallback = detachedCallback;
    function hasLazyParent(node) {
        while (node = node.parentNode) {
            if (node.hasAttribute && node.hasAttribute("lazy"))
                return true;
        }
        return false;
    }
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudC9yZWdpc3Rlci9wcm90b3R5cGUudHMiXSwibmFtZXMiOlsiY3JlYXRlUHJvdG90eXBlIiwiY3JlYXRlUHJvdG90eXBlLmciLCJhc3NpZ25DYWxsYmFjayIsImNyZWF0ZWRDYWxsYmFjayIsImF0dGFjaGVkQ2FsbGJhY2siLCJkZXRhY2hlZENhbGxiYWNrIiwiaGFzTGF6eVBhcmVudCJdLCJtYXBwaW5ncyI6IjtJQVFBOztPQUVHO0lBQ0gseUJBQXlCLE1BQVU7UUFDbENBLElBQUlBLEtBQUtBLEdBQUdBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBO1FBRWpEQSxXQUFXQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUNQQyxHQUFHQSxDQUFDQTtnQkFBQUEsRUFBRUEsQ0FBQUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO2dCQUFDQSxJQUFJQTtvQkFBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsU0FBU0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQUE7WUFBQUEsQ0FBQ0EsUUFBT0EsSUFBSUEsRUFBQ0E7UUFDekZBLENBQUNBO1FBQ1JELEdBQUdBLENBQUFBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBQ2pDQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQSxLQUFLQSxFQUFFQSxHQUFHQSxFQUFFQSxNQUFNQSxDQUFDQSx3QkFBd0JBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLEVBQUVBLEdBQUdBLENBQUNBLEVBQUVBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1FBQ25HQSxDQUFDQTtRQUVEQTs7Ozs7Ozs7Ozs7O1VBWUVBO1FBQ0ZBLE1BQU1BLENBQUNBLEtBQUtB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LENBQUNBLENBQUNBO1FBQ3pCQSxDQUFDQSxDQUFDQSxDQUFBQTtRQUNGQSxJQUFJQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQTtJQUNqQkEsQ0FBQ0E7SUFVMkUsd0JBQWdCLG9CQVYzRjtJQUVELHVCQUF1QixJQUFRO1FBQzlCQyxPQUFNQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQTtZQUM5QkEsRUFBRUEsQ0FBQUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsSUFBSUEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ2pEQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUNkQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtJQUNkQSxDQUFDQTtJQUU0RiIsImZpbGUiOiJjb21wb25lbnQvcmVnaXN0ZXIvcHJvdG90eXBlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFdmVudEJ1c30gZnJvbSBcImhvcmNydXgtZXZlbnRcIlxyXG5pbXBvcnQge2dldH0gZnJvbSBcImhvcmNydXgtZGlcIlxyXG5cclxuaW1wb3J0IHtDb21wb25lbnRDcmVhdGVkRXZlbnQsIENvbXBvbmVudFJlYWR5RXZlbnQsIENvbXBvbmVudENhbkJpbmRFdmVudH0gZnJvbSBcIi4vZXZlbnRzXCJcclxuaW1wb3J0IHtDb21wb25lbnRSZWdpc3RyeX0gZnJvbSBcIi4uL2NvbXBvbmVudHJlZ2lzdHJ5XCJcclxuaW1wb3J0IHtFbGVtZW50UmVnaXN0ZXJlZH0gZnJvbSBcIi4vcmVnaXN0ZXJcIlxyXG5pbXBvcnQge2JpbmREb219IGZyb20gXCIuLi8uLi9iaW5kL2JpbmRcIlxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZXMgYSBuZXcgSFRNTEVsZW1lbnQucHJvdG90eXBlLCBhc3NpZ25zIGFsbCBwcm9wZXJ0aWVzIG9mICduZXcgdGFyZ2V0KCknIHRvIGl0IGFuZCByZXR1cm5zIGl0OyBcclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZVByb3RvdHlwZSh0YXJnZXQ6YW55KTogYW55IHtcclxuXHRsZXQgcHJvdG8gPSBPYmplY3QuY3JlYXRlKEhUTUxFbGVtZW50LnByb3RvdHlwZSk7XHJcblx0XHJcblx0ZnVuY3Rpb24gZyhwLCBrKSB7XHJcbiAgICAgICAgXHRkbyB7aWYocC5oYXNPd25Qcm9wZXJ0eShrKSkgcmV0dXJuIHA7IGVsc2UgcCA9IChwLnByb3RvdHlwZSB8fCBwLl9fcHJvdG9fXyl9IHdoaWxlKHRydWUpXHJcbiAgICAgICAgfVxyXG5cdGZvcih2YXIga2V5IGluIHRhcmdldC5wcm90b3R5cGUpIHtcclxuXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90bywga2V5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGcodGFyZ2V0LnByb3RvdHlwZSwga2V5KSwga2V5KSk7XHJcblx0fVxyXG5cdFxyXG5cdC8qXHJcblx0bGV0IHQgPSB0YXJnZXQ7XHJcblx0ZG8ge1xyXG5cdFx0dCA9IHQucHJvdG90eXBlIHx8IHQuX19wcm90b19fO1xyXG5cdFx0T2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModClcclxuXHRcdC5mb3JFYWNoKGtleSA9PiB7XHJcblx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90bywga2V5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIGtleSkpO1xyXG5cdFx0fSlcclxuXHR9IHdoaWxlKCEhKHQucHJvdG90eXBlIHx8IHQuX19wcm90b19fKSlcclxuXHRcclxuXHRmb3IobGV0IGtleSBpbiB0YXJnZXQucHJvdG90eXBlKVxyXG5cdFx0cHJvdG9ba2V5XSA9IHRhcmdldC5wcm90b3R5cGVba2V5XTtcclxuXHQqL1xyXG5cdHJldHVybiBwcm90bztcclxufVxyXG5cclxuLyoqXHJcbiAqIEFkZHMgYSBmdW5jdGlvbiBuYW1lZCAna2V5JyB0byAndGFyZ2V0Jywgd2hpY2ggaXMgYSBmdW5jdGlvbiB0aGF0IGNhbGxzICdjYicgd2l0aCBnaXZlbiAnYXJncydcclxuICogYW5kIHRoZW4gY2FsbHMgdGhlIHByZXZpb3VzICd0YXJnZXRba2V5XScgaWYgaXQgd2FzIGEgZnVuY3Rpb24gd2l0aCAnYXJncycuIFxyXG4gKi9cclxuZnVuY3Rpb24gYXNzaWduQ2FsbGJhY2sodGFyZ2V0OmFueSwga2V5OnN0cmluZywgY2I6RnVuY3Rpb24sIGFyZ3M9W10pOiB2b2lkIHtcclxuXHRsZXQgb3JpZ2luYWwgPSB0YXJnZXRba2V5XTtcclxuXHR0YXJnZXRba2V5XSA9IGZ1bmN0aW9uKCkge1xyXG5cdFx0Y2IuYXBwbHkodGhpcywgYXJncyk7XHJcblx0XHR0eXBlb2Ygb3JpZ2luYWwgPT09IFwiZnVuY3Rpb25cIiA/IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiAnJztcclxuXHR9XHJcbn1cclxuXHJcblxyXG4vKipcclxuICogRGVmYXVsdCAnY3JlYXRlZENhbGxiYWNrJyBmb3IgYSBDdXN0b21lbGVtZW50LiBBcHBlbmRzIHRoZSAndGVtcGxhdGUnIGNvbnRlbnQgdG8gc2hhZG93cm9vdCwgaWYgISF0ZW1wbGF0ZVxyXG4gKi9cclxuZnVuY3Rpb24gY3JlYXRlZENhbGxiYWNrKHRlbXBsYXRlOmFueSwgdGFyZ2V0OmFueSk6dm9pZCB7XHJcblx0XHJcblx0dGFyZ2V0LmNhbGwodGhpcyk7XHJcblx0XHJcblx0aWYoISF0ZW1wbGF0ZSkge1xyXG5cdFx0bGV0IHNoYWRvdyA9IHRoaXMuY3JlYXRlU2hhZG93Um9vdCgpO1xyXG5cdFx0bGV0IGNsb25lID0gZG9jdW1lbnQuaW1wb3J0Tm9kZSh0ZW1wbGF0ZS5jb250ZW50LCB0cnVlKTtcclxuXHRcdHNoYWRvdy5hcHBlbmRDaGlsZChjbG9uZSk7XHJcblx0XHRcclxuXHRcdGxldCB3YyA9IHdpbmRvd1tcIldlYkNvbXBvbmVudHNcIl07XHJcblx0XHRpZih3YyAmJiB3Yy5TaGFkb3dDU1MpXHJcblx0XHRcdHdjLlNoYWRvd0NTUy5zaGltU3R5bGluZyh0ZW1wbGF0ZS5jb250ZW50LCB0YXJnZXQuc2VsZWN0b3IsIFwiXCIpO1xyXG5cdFx0XHJcblx0XHRcdFxyXG5cdFx0aWYodGVtcGxhdGUuaGFzQXR0cmlidXRlKFwibGF6eVwiKSB8fCB0aGlzLmhhc0F0dHJpYnV0ZShcImxhenlcIikpXHJcblx0XHRcdHRoaXMubGF6eSA9IHRydWU7XHJcblx0XHRcclxuXHRcdGlmKCF0aGlzLmxhenkgJiYgISh0aGlzLnBhcmVudENvbXBvbmVudCAmJiB0aGlzLnBhcmVudENvbXBvbmVudC5sYXp5KSAmJiAhaGFzTGF6eVBhcmVudCh0aGlzKSlcclxuXHRcdFx0YmluZERvbShzaGFkb3csIFt0aGlzXS5jb25jYXQodGhpcy5hbmNlc3RvcnMpKTtcclxuXHRcdGVsc2UgaWYodGhpcy5sYXp5KXtcclxuXHRcdFx0bGV0IHVuY3JlYXRlZCA9IFtdLmZpbHRlci5jYWxsKHNoYWRvdy5xdWVyeVNlbGVjdG9yQWxsKFwiKlwiKSwgZWxlbWVudCA9PiB7cmV0dXJuIGVsZW1lbnQubm9kZU5hbWUuaW5kZXhPZihcIi1cIikgPiAtMX0pO1xyXG5cdFx0XHRsZXQgaWQxID0gdGhpcy5ldmVudEJ1cy5hZGRFdmVudExpc3RlbmVyKENvbXBvbmVudENyZWF0ZWRFdmVudCwgZSA9PiB7XHJcblx0XHRcdFx0bGV0IGluZGV4ID0gdW5jcmVhdGVkLmluZGV4T2YoZS5kYXRhKTtcclxuXHRcdFx0XHRpZihpbmRleCA+IC0xKSB1bmNyZWF0ZWQuc3BsaWNlKGluZGV4LCAxKTtcclxuXHRcdFx0XHRpZih1bmNyZWF0ZWQubGVuZ3RoID09IDApIHtcclxuXHRcdFx0XHRcdGJpbmREb20oc2hhZG93LCBbdGhpc10uY29uY2F0KHRoaXMuYW5jZXN0b3JzKSk7XHJcblx0XHRcdFx0XHR0aGlzLmV2ZW50QnVzLnJlbW92ZUV2ZW50TGlzdGVuZXIoaWQxKTtcclxuXHRcdFx0XHRcdHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2gobmV3IENvbXBvbmVudFJlYWR5RXZlbnQodGhpcykpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSlcclxuXHRcdFx0bGV0IGlkMiA9IHRoaXMuZXZlbnRCdXMuYWRkRXZlbnRMaXN0ZW5lcihDb21wb25lbnRDYW5CaW5kRXZlbnQsIGUgPT4ge1xyXG5cdFx0XHRcdGJpbmREb20oc2hhZG93LCBbdGhpc10uY29uY2F0KHRoaXMuYW5jZXN0b3JzKS5jb25jYXQoISFlLmRhdGEgPyBlLmRhdGEgOiBbXSkpO1xyXG5cdFx0XHRcdHRoaXMuZXZlbnRCdXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihpZDEpXHJcblx0XHRcdFx0dGhpcy5ldmVudEJ1cy5yZW1vdmVFdmVudExpc3RlbmVyKGlkMik7XHJcblx0XHRcdH0pXHJcblx0XHR9XHJcblx0XHRlbHNlIGlmKHRoaXMucGFyZW50Q29tcG9uZW50ICYmIHRoaXMucGFyZW50Q29tcG9uZW50LmxhenkpIHtcclxuXHRcdFx0bGV0IGlkID0gdGhpcy5wYXJlbnRDb21wb25lbnQuZXZlbnRCdXMuYWRkRXZlbnRMaXN0ZW5lcihDb21wb25lbnRSZWFkeUV2ZW50LCBlID0+IHtcclxuXHRcdFx0XHRiaW5kRG9tKHNoYWRvdywgW3RoaXNdLmNvbmNhdCh0aGlzLmFuY2VzdG9ycykpO1xyXG5cdFx0XHRcdHRoaXMucGFyZW50Q29tcG9uZW50LmV2ZW50QnVzLnJlbW92ZUV2ZW50TGlzdGVuZXIoaWQpO1xyXG5cdFx0XHR9KVxyXG5cdFx0fVxyXG5cdFx0ZWxzZSBpZighdGhpcy5wYXJlbnRDb21wb25lbnQgJiYgaGFzTGF6eVBhcmVudCh0aGlzKSkge1xyXG5cdFx0XHRsZXQgaWQgPSB0aGlzLmV2ZW50QnVzLmFkZEV2ZW50TGlzdGVuZXIoQ29tcG9uZW50Q2FuQmluZEV2ZW50LCBlID0+IHtcclxuXHRcdFx0XHRiaW5kRG9tKHNoYWRvdywgW3RoaXNdLmNvbmNhdCh0aGlzLmFuY2VzdG9ycykuY29uY2F0KCEhZS5kYXRhID8gZS5kYXRhIDogW10pKTtcclxuXHRcdFx0XHR0aGlzLmV2ZW50QnVzLnJlbW92ZUV2ZW50TGlzdGVuZXIoaWQpO1xyXG5cdFx0XHR9KVxyXG5cdFx0fVxyXG5cdFx0XHJcblx0XHQvKlxyXG5cdFx0bGV0IHVucmVzb2x2ZWQgPSBbXS5maWx0ZXIuY2FsbChzaGFkb3cucXVlcnlTZWxlY3RvckFsbChcIipbd2FpdF1cIiksIGVsZW1lbnQgPT4ge1xyXG5cdFx0XHRyZXR1cm4gIShlbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgaW4gQ29tcG9uZW50UmVnaXN0cnkpO1xyXG5cdFx0fSkubWFwKGVsZW1lbnQgPT4ge1xyXG5cdFx0XHRyZXR1cm4gZWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpO1xyXG5cdFx0fSlcclxuXHRcdC5zb3J0KClcclxuXHRcdC5yZWR1Y2UoKGEsIGIpID0+IHsgaWYgKGIgIT0gYVswXSkgYS51bnNoaWZ0KGIpOyByZXR1cm4gYSB9LCBbXSk7XHJcblx0XHRcclxuXHRcdGlmKHVucmVzb2x2ZWQubGVuZ3RoID4gMCkge1xyXG5cdFx0XHRsZXQgZWIgPSBnZXQoRXZlbnRCdXMpO1xyXG5cdFx0XHRsZXQgaWQgPSBlYi5hZGRFdmVudExpc3RlbmVyKEVsZW1lbnRSZWdpc3RlcmVkLCBlID0+IHtcclxuXHRcdFx0XHRsZXQgaW5kZXggPSB1bnJlc29sdmVkLmluZGV4T2YoZS5kYXRhKTtcclxuXHRcdFx0XHRpZihpbmRleCA9PT0gLTEpIHJldHVybjtcclxuXHRcdFx0XHR1bnJlc29sdmVkLnNwbGljZShpbmRleCwgMSk7XHJcblx0XHRcdFx0aWYodW5yZXNvbHZlZC5sZW5ndGggPT09IDApIHtcclxuXHRcdFx0XHRcdGViLnJlbW92ZUV2ZW50TGlzdGVuZXIoRWxlbWVudFJlZ2lzdGVyZWQsIGlkKTtcclxuXHRcdFx0XHRcdGJpbmREb20oc2hhZG93LCBbdGhpc10pO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRiaW5kRG9tKHNoYWRvdywgW3RoaXNdKTtcclxuXHRcdH1cclxuXHRcdCovXHJcblx0XHRcclxuXHR9XHJcblx0XHJcblx0dGhpcy5vbkNyZWF0ZWQuZm9yRWFjaChtZXRob2QgPT4ge1xyXG5cdFx0bWV0aG9kLmNhbGwodGhpcywgdGhpcyk7XHJcblx0fSlcclxuXHRcclxuXHR0aGlzLmNyZWF0ZWQoKTtcclxuXHRcclxuXHRcclxufVxyXG5cclxuZnVuY3Rpb24gYXR0YWNoZWRDYWxsYmFjaygpOiB2b2lkIHtcclxuXHRpZih0aGlzLnBhcmVudENvbXBvbmVudCAmJiB0aGlzLnBhcmVudENvbXBvbmVudC5sYXp5KVxyXG5cdFx0dGhpcy5wYXJlbnRDb21wb25lbnQuZXZlbnRCdXMuZGlzcGF0Y2gobmV3IENvbXBvbmVudENyZWF0ZWRFdmVudCh0aGlzKSk7XHJcblx0XHJcblx0dGhpcy5vbkF0dGFjaGVkLmZvckVhY2gobWV0aG9kID0+IHtcclxuXHRcdG1ldGhvZC5jYWxsKHRoaXMsIHRoaXMpO1xyXG5cdH0pXHJcblx0XHJcblx0dGhpcy5hdHRhY2hlZCgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBkZXRhY2hlZENhbGxiYWNrKCk6IHZvaWQge1xyXG5cdHRoaXMub25EZXRhY2hlZC5mb3JFYWNoKG1ldGhvZCA9PiB7XHJcblx0XHRtZXRob2QuY2FsbCh0aGlzLCB0aGlzKTtcclxuXHR9KVxyXG5cdHRoaXMuZGV0YWNoZWQoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGFzTGF6eVBhcmVudChub2RlOmFueSk6IGJvb2xlYW4ge1xyXG5cdHdoaWxlKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpIHtcclxuXHRcdGlmKG5vZGUuaGFzQXR0cmlidXRlICYmIG5vZGUuaGFzQXR0cmlidXRlKFwibGF6eVwiKSlcclxuXHRcdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cdHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuZXhwb3J0IHtjcmVhdGVQcm90b3R5cGUsIGFzc2lnbkNhbGxiYWNrLCBjcmVhdGVkQ2FsbGJhY2ssIGF0dGFjaGVkQ2FsbGJhY2ssIGRldGFjaGVkQ2FsbGJhY2t9Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9